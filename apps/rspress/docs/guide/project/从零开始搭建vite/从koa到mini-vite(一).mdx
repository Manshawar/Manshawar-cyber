# ä» koa åˆ° mini-viteï¼ˆä¸€ï¼‰é¢„æ„å»º

### 1ã€vite çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ

<p>viteå®è´¨ä¸Šæ¥è®²ï¼Œå®ƒæ˜¯ä¸€ä¸ªnodeèµ„æºæœåŠ¡å™¨ï¼Œé€šè¿‡æ­å»ºmini-viteï¼Œæˆ‘æ·±å…¥çš„è®¤è¯†åˆ°äº†è¿™ç‚¹ï¼Œviteæ•´ä½“çš„æµç¨‹å°±æ˜¯é€šè¿‡å¯¹å¼•å…¥åŒ…æ‰«æçš„é¢„æ„å»ºï¼Œé…åˆæ’ä»¶å®¹å™¨å¯¹äºé¢„æ„å»ºèµ„æºçš„å¤„ç†ï¼Œæœ€åé€šè¿‡wså’Œä¾èµ–æ”¶é›†ï¼Œæ¥å®ç°çƒ­æ›´æ–°ã€‚è¯´å®åœ¨ç‚¹å°±æ˜¯ä½ æƒ³æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œä»–å¤„ç†jsæ–‡ä»¶è¿”å›ç»™ä½ ï¼Œè®©ä½ çš„æµè§ˆå™¨èƒ½è¯†åˆ«ï¼Œæ—¢ç„¶æ˜¯æœåŠ¡å™¨ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ä»»ä½•çš„nodeæ¡†æ¶è¿›è¡Œæ­å»ºï¼›</p>

è¿™ä¸ªæ˜¯ä»“åº“åœ°å€

[![Readme Card](https://github-readme-stats.vercel.app/api/pin/?username=Manshawar&repo=koa_vite)](https://github.com/Manshawar/koa_vite)
### 2ã€é¡¹ç›®çš„æŠ€æœ¯é€‰å‹

koa+ts+esbuild+fs-extra

æ­¤é¡¹ç›®ä½¿ç”¨ tsx è¿è¡Œ

- tsx æ‹¥æœ‰è‡ªå¸¦çš„ watch æ¨¡å¼ï¼Œéå¸¸å¥½ç”¨
- ts-node ç»™æˆ‘äº†å¾ˆå¤šéº»çƒ¦ï¼Œå› ä¸ºä»–ä¼šåœ¨ commomJs å’Œ module æ¨¡å—æ··ç”¨çš„æ—¶å€™å‡ºé—®é¢˜
- ts-node çš„ issue æœ‰äººæ¨è tsxğŸ˜

ä¸ºä»€ä¹ˆé€‰æ‹© koaï¼Œæ— ä»–ï¼Œå› ä¸ºä»–è¶³å¤Ÿç®€å•ï¼Œå¯ä»¥ç›´æ¥ä¸Šæ‰‹ä½¿ç”¨ã€‚é€‰æ‹©ç”¨ typescript è¿›è¡Œå¼€å‘ï¼Œå› ä¸º ts çš„å¥½å¤„å°±åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å¼•å…¥çš„åŒ…æœ‰å“ªäº›æ–¹æ³•ï¼Œæ›´åŠ ä¾¿äºæˆ‘ä»¬ä¹¦å†™æ–¹æ³•ï¼ŒåŒæ—¶å‡å°‘ä»£ç å‡º bugger çš„å¯èƒ½æ€§ã€‚

ä½¿ç”¨ koa æ­å»ºè¿™ä¸ªé¡¹ç›®ï¼Œè¿™ä¸ªé¡¹ç›®åªæ˜¯ä¸€ä¸ªå­¦ä¹ é¡¹ç›®ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªå…·å¤‡é«˜å¯ç”¨æ€§çš„é¡¹ç›®ï¼Œä¼˜å…ˆçº§æ˜¯ä»¥å¦‚ä½•æœ€å®¹æ˜“çœ‹æ‡‚æ¥å®ç°çš„ï¼Œæ‰€ä»¥ koa æ­å»ºçš„è¿™ä¸ªæœåŠ¡å™¨å¹¶ä¸ä¼šè¿›è¡Œä»»ä½•çš„æ‰“åŒ…ï¼Œå¦‚æœæƒ³ä½“éªŒæ‰“åŒ…åçš„äº§ç‰©ï¼Œå»ºè®®å¯ä»¥ä½¿ç”¨ä¸€ä¸‹ tsupï¼Œä¿ºå®åŠ›ä¼˜å…ˆï¼Œç°é˜¶æ®µæ²¡æ³•æ‰‹å†™ bundle å°±ä¸è€ƒè™‘ä¸€åˆ‡æ‰“åŒ…ç›¸å…³çš„ä¸œè¥¿äº†ã€‚

å†æ¬¡å ç”²ã€‚è¿™ä¸ªé¡¹ç›®ä¸æ˜¯é‚£ä¹ˆä¸¥è°¨çš„ï¼Œé«˜å¯ç”¨çš„ï¼Œè¿™ä¸ªé¡¹ç›®ä¸»è¦ç›®çš„ä¸€æ˜¯å¸®åŠ©ç©·å“¥ä»¬å©å¼€å·¥ç¨‹åŒ–çš„é—¨ç¼(å°±è¿™ä¸‰è„šçŒ«åŠŸå¤«ï¼Œæˆ‘è§‰å¾—ä¸èƒ½ç§°ä¹‹ä¸ºå¤§é—¨ğŸ¥¹)ã€‚å…¶æ¬¡æ˜¯å¯¹è‡ªå·±è¿™æ®µæ—¶é—´çš„è„šæ‰‹æ¶å­¦ä¹ ç»™ä¸€ä¸ªäº¤ä»£ï¼Œæˆ‘è®¤ä¸ºæœ‰è¾“å…¥äº†ï¼Œè¿˜æ˜¯è¦æœ‰ç‚¹è¾“å‡ºï¼Œæ›´èƒ½å·©å›ºçŸ¥è¯†ç‚¹ï¼Œå…¶æ¬¡è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¤‡å¿˜å½•

ä»¥ä¸‹æ˜¯ package.json æ–‡ä»¶ï¼Œå¦‚æœæœ‰å“¥ä»¬æƒ³å®ç°çš„è¯å¯ä»¥å¤åˆ¶ä¸€ä¸‹ã€‚

```json
{
  "dependencies": {
    "@types/connect": "^3.4.38",
    "@types/debug": "^4.1.12",
    "@types/fs-extra": "^11.0.4",
    "@types/resolve": "^1.20.6",
    "@types/ws": "^8.5.13",
    "cac": "^6.7.14",
    "chokidar": "^4.0.1",
    "connect": "^3.7.0",
    "cross-env": "^7.0.3",
    "debug": "^4.3.7",
    "es-module-lexer": "^1.5.4",
    "esbuild": "^0.24.0",
    "fs-extra": "^11.2.0",
    "koa": "^2.15.3",
    "magic-string": "^0.30.13",
    "picocolors": "^1.1.1",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "resolve": "^1.22.8",
    "rollup": "^4.27.3",
    "sirv": "^3.0.0",
    "tsup": "^8.3.5",
    "ws": "^8.18.0"
  },

  "scripts": {
    "dev": "cross-env NODE_ENV=dev tsx watch ./src/index.ts  "
  },
  "devDependencies": {
    "@types/koa": "^2.15.0",
    "@types/node": "^22.9.1",
    "file-loader": "^6.2.0"
  }
}
```

### 3ã€ä½¿ç”¨ koa æ­å»ºä¸€ä¸ªæœåŠ¡å™¨

```ts
import Koa from "koa";
const app = new Koa();
//import { optimize } from "./node/optimizer";
//const root = process.cwd()
app.use(ctx => {
  ctx.body = "hello Koa";
});
app.listen(3000, async () => {
  //await optimize(root)
  console.log("http://localhost:3000 ");
});
```

å—¯....ï¼Œè¿™æ˜¯ä¸ªæœ‰æ‰‹å°±è¡Œçš„å·¥ä½œï¼Œä¸ä¼šæœ‰äººä¸ä¼šå§ï¼Œä¸ä¼šå§ï¼Œä¸ä¼šå§ï¼Œèƒ½çœ‹åˆ° hello koa å°±ç®—æˆåŠŸ
### 4ã€ä»zhangsanæ–‡ä»¶å¼€å§‹ï¼Œç†è§£ä½•ä¸ºèµ„æºæœåŠ¡å™¨

æˆ‘ä»¬æ¥çœ‹è¿™æ®µä»£ç 

```ts
import fs from "fs-extra";
import path from "path";

app.use(async (ctx, next) => {
  const { req, res } = ctx;

  if (req.url?.endsWith(".zhangsan") || (req.url === "/zhangsan"&&req.method === "GET")) {
    const realPath = path.join(process.cwd(), req.url + (req.url === "/zhangsan" ? ".html" : ""));
    if (await fs.pathExists(realPath)) {
      const code = await fs.readFile(realPath, "utf-8");
      res.statusCode = 200;
      req.url === "/zhangsan" ? res.setHeader("Content-Type", "text/html") : res.setHeader("Content-Type", "application/javascript");
      
      res.end(code)
    }
  }
  return next()
})

```
è¿™æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä»–çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è§£æåç¼€ä¸º.zhangsançš„æ–‡ä»¶ï¼ŒåŒæ—¶ å†è·¯ç”±å¯¼èˆªåˆ°zhangsanè·¯ç”±çš„æ—¶å€™ï¼Œä¼šè¯»å–æ ¹ç›®å½•ä¸‹çš„zhangsan.htmlæ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡readFileè¯»å–æ–‡ä»¶ï¼Œå°†å…¶è¿”å›çš„content-typeï¼Œæ”¹ä¸ºhtmlï¼Œæˆ‘ä»¬çš„æµè§ˆå™¨å°±å¯ä»¥è¯»å–è¿™ä¸ªé¡µé¢äº†

è¿™é‡Œæ˜¯zhangsan.html ä»–åœ¨æ ¹ç›®å½•ä¸‹ï¼›

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="zhangsan"></div>
  <script type="module" src="src/node/zhangsan/1.zhangsan"></script>
</body>

</html>


```
å½“è¿™æ®µä»£ç è¢«æµè§ˆå™¨è¯»å–åï¼Œä»–çš„scriptæ ‡ç­¾ä¼šå‘æˆ‘ä»¬çš„æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚urlæ˜¯`src/node/zhangsan/1.zhangsan`ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨èƒ½ç›´æ¥æ‹¦æˆªåˆ°åç¼€ä¸º`.zhangsan`çš„è¯·æ±‚ è§ä»£ç `req.url?.endsWith(".zhangsan") `,ç„¶åæˆ‘ä»¬éªŒè¯è¿™ä¸ªåœ°å€æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±ä½¿ç”¨utf-8çš„æ ¼å¼å»è¯»å–ä»–ï¼Œè¿”å›æ—¶å°†å“åº”å¤´è®¾ç½®ä¸ºjsï¼Œæˆ‘ä»¬çš„æµè§ˆå™¨å°±ä¼šå»æ‰§è¡Œä»–ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„zhangsanæ–‡ä»¶
```js
//src/node/zhangsan/1.zhangsan
import a from "./a.zhangsan";
document.getElementById("zhangsan").innerHTML = "zhangsan";
console.log(a)

```
ç”šè‡³ä»–è¿˜æ”¯æŒæ¨¡å—åŒ–ï¼›
```js
//src/node/zhangsan/a.zhangsan
export default {
  a:1
}

```
ä½ å¯ä»¥çœ‹åˆ°é¡µé¢

<img src="/vite/koa_vite/zhangsan.png" />

ä½ å¯ä»¥é€šè¿‡networkæŸ¥çœ‹æˆ‘ä»¬çš„è¯·æ±‚
<img src="/vite/koa_vite/zhangsannet.png" />

ä½ ç°åœ¨åº”è¯¥äº†è§£åˆ°ä¸€ç‚¹æ•™æˆæ¶çš„åŸºç¡€äº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹ä¸Šè½¦äº†å“¦ğŸ˜šï¼›ä¸äº†è§£ä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥å»éš”å£çš„cyberè„šæ‰‹æ¶ï¼Œä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¸¦ä½ è¿‡å®Œreactæˆ–è€…vueæ‰§è¡Œçš„ä¸€ç”Ÿï¼Œåªä¸è¿‡æ˜¯æœ‹å…‹é£ï¼Œé’æ˜¥ç‰ˆçš„è€Œå·²ğŸ˜
è¿™é‡Œæ˜¯æ˜é‡‘åœ°å€



### 5ã€è¿›è¡Œä¾èµ–çš„é¢„æ„å»º

æé—®ï¼šä¸ºä»€ä¹ˆè¦è¿›è¡Œä¾èµ–çš„é¢„æ„å»ºã€‚

å½“ç„¶æ˜¯å¯¹äºå¤–éƒ¨å¼•å…¥çš„èµ„æºè¿›è¡Œå¤„ç†ï¼Œnode_modules é‡Œçš„åŒ…ï¼Œvite æ˜¯ä¸ä¼šç›´æ¥å¼•ç”¨çš„ï¼Œä¼šå…ˆè¿›è¡Œä¾èµ–æ‰«æï¼Œå°†æˆ‘ä»¬å®‰è£…çš„ä¸€äº›åŒ…å¦‚ vue,react,element ç­‰ï¼Œè¿™ç§å¤–éƒ¨èµ„æºåŒ…é€šè¿‡ esbuild è¿›è¡Œç¼–è¯‘ï¼Œå½¢æˆä¸€ä¸ª.vite çš„ç¼“å­˜æ–‡ä»¶ã€‚åç»­é’©å­çš„å¤„ç†éƒ½æ˜¯ä».vite ä¸­æå–çš„èµ„æº,æŒ‰ç…§å·¥åœ°çš„è¯è®²ï¼Œè¿™æ˜¯æ‰“ç°ã€‚ğŸ˜

#### 5-1ã€ä¸ºä»€ä¹ˆè¦è¿›ä¸€æ­¥çš„å¤„ç†

å¦‚ä¸‹å›¾ï¼š

<div style={{ display: "flex", gap: "10px" }}>
  <img width="50%" src="/vite/koa_vite/react.png" />
  <img width="50%" src="/vite/koa_vite/vue.png" />
</div>
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°,æ— è®ºæ˜¯reactè¿˜æ˜¯vue,ä»–ä»¬æ‰“åŒ…åçš„äº§ç‰©éƒ½æ˜¯é€šè¿‡**commonjs**è¿›è¡Œçš„,ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬æ˜¯æ— æ³•åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æ‰§è¡Œçš„,æ‰€ä»¥éœ€è¦åšä¸€æ¬¡**è½¬æ¢**ã€‚å…¶åŸå› æ˜¯å®ƒä»¬çš„ç”Ÿæ€ç³»ç»Ÿä¸­å¾ˆå¤š**åº“å’Œå·¥å…·æ˜¯åŸºäº
Node.js æ„å»º**çš„ã€‚å› æ­¤ï¼Œè¿™äº›åº“å’Œå·¥å…·é€šå¸¸ä¼šä»¥ **CommonJS æ ¼å¼**å‘å¸ƒï¼Œä»¥ä¾¿äºåœ¨ **Node.jsç¯å¢ƒä¸­ä½¿ç”¨ã€‚**,è€Œä¸”ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¿«çš„æ„å»ºé€Ÿåº¦ï¼Œè€Œè¯»å–ç¼“å­˜åˆ™æ˜¯å¸¸ç”¨çš„æ–¹æ³•ã€‚** è€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ç¿»éäº†reactå’Œreact-domçš„æ‰€æœ‰åŒ…ï¼Œå®ƒé»˜è®¤æ²¡æœ‰esæ¨¡å—çš„åŒ…ï¼Œç›´æ¥ä½¿ç”¨`import React from "react"`æ˜¯æ ¹æœ¬ç”¨ä¸äº†çš„ğŸ˜’;  **

#### 5-2ã€æ‰“å¼€ä½ çš„ node_modules åŒ…ï¼Œæ‰¾åˆ°.vite æ–‡ä»¶

æœ‰æ²¡æœ‰å‘ç°ä½ çš„ node_modules åŒ…ï¼Œvite é¡¹ç›®ä¸­æœ‰ä¸€ä¸ª.vite çš„æ–‡ä»¶ï¼Œä½ åˆ é™¤äº†ä½ çš„é¡¹ç›®å°± G äº† ğŸ˜ï¼Œå¾—é‡æ–°è¿›è¡Œ buildï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ;è®©æˆ‘ä»¬æ¥çœ‹çœ‹.vite åŒ…æ˜¯ç”±ä»€ä¹ˆæ„æˆçš„

<img src="/vite/koa_vite/.vite.png" />

ä½ ä¼šå‘ç°ï¼ŒåŒ…é‡Œä¼šå­˜åœ¨ä¼¼æ›¾ç›¸è¯†çš„åŒ…çš„åå­—ï¼Œå› ä¸ºåœ¨ä¾èµ–é¢„æ„å»ºé˜¶æ®µï¼Œ**vite ä¼šå°† bare import çš„è·¯å¾„è§†ä½œç¬¬ä¸‰æ–¹åŒ…ï¼Œ**ï¼Œ**ä½¿ç”¨ esbuild æ‰“åŒ…**ï¼Œ**å°†å…¶ç¼“å­˜åˆ°.vite æ–‡ä»¶ï¼Œè¿™ä¹Ÿæ˜¯ vite é«˜æ€§èƒ½çš„ç”±æ¥ï¼Œ** **vite æ˜¯ esbuild å’Œ rollup åŒå¼•æ“ï¼Œrollup ä¸ºä¸»ä½“ï¼Œesbuild ç›¸å½“äºä¸€ä¸ªå‚¬åŒ–å‰‚**ï¼› 

è¿™æ˜¯ vite çš„åŒå¼•æ“æµç¨‹å›¾ï¼Œè¯·å…³æ³¨äºå·¦è¾¹çš„å¼€å‘é˜¶æ®µï¼Œå½“å‰çš„å·¥ä½œå°±æ˜¯ pre-bundleï¼Œä½¿ç”¨ esbuild è¿›è¡Œä¾èµ–é¢„æ„å»º

<img src="/vite/koa_vite/esbuild&esbuild.png" />

> bare import æ˜¯ä»€ä¹ˆï¼šåœ¨ JavaScript æ¨¡å—ç³»ç»Ÿä¸­ï¼Œ"bare import"ï¼ˆè£¸å¯¼å…¥ï¼‰æ˜¯æŒ‡åœ¨ import è¯­å¥ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæ¨¡å—çš„åç§°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ URL æˆ–ç›¸å¯¹è·¯å¾„

é€šä¿—çš„è®²ï¼Œå°†æˆ‘ä»¬è¦ç”¨çš„ä¾èµ–åŒ…é€šè¿‡ esbuild è½¬åŒ–ä¸ºç¼“å­˜ï¼Œç”¨æ¥æå‡æ„å»ºé€Ÿåº¦ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—ï¼Œè¿™ä¸ªæ˜¯æœ‰æ„ä¹‰çš„ï¼Œåç»­æˆ‘ä»¬å¯¹äºbareè£¸å¼•å…¥å¤„ç†çš„æ—¶å€™ï¼Œå¦‚import React from "react"ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†è·¯å¾„æ”¹å†™è‡³.viteè·¯å¾„ä¸­ï¼Œç›´æ¥è¯»å–æ‰“åŒ…å¥½çš„ä»£ç 

#### 5-3ã€å¼€å§‹ä¹¦å†™ esbuild æ„å»ºä»£ç 

è¿™é‡Œæ˜¯å…¥å£æ–‡ä»¶çš„ä»£ç  index.tsï¼Œå…¶ä¸­çš„optimizeræ˜¯è¿›è¡Œé¢„æ„å»ºçš„å‡½æ•°

```ts
import Koa from "koa";
const app = new Koa();
import { optimize } from "./node/optimizer";
const root = process.cwd();
app.use(ctx => {
  ctx.body = "hello Koa";
});
app.listen(3000, async () => {
  await optimize(root);
  console.log("http://localhost:3000 ");
});
```

æˆ‘ä»¬æ¥åº·åº· optimizer æ–‡ä»¶æ˜¯æ€ä¹ˆä¸ªäº‹

```ts
import path from "path";
import { build } from "esbuild";
import { scanPlugin } from "./scanplugin";
import { preBundlePlugin } from "./preBundlePlugin";
import { PRE_BUNDLE_DIR } from "../contants"; //path.join("node_modules", ".m-vite")
export async function optimize(root: string) {
  // 1. ç¡®å®šå…¥å£
  // 2. ä»å…¥å£å¤„æ‰«æä¾èµ–
  // 3. é¢„æ„å»ºä¾èµ–;
  const deps = new Set<string>();
  const entry = path.resolve(root, "src/client/main.tsx");
  await build({
    entryPoints: [entry],
    bundle: true,
    write: false,
    plugins: [scanPlugin(deps)],
  });
  await build({
    entryPoints: [...deps],
    write: true,
    bundle: true,
    format: "esm",
    splitting: true,
    outdir: path.resolve(root, PRE_BUNDLE_DIR), //è¿™ä¸ªåˆæˆè·¯å¾„æ˜¯ process.cwd() + "/node_modules/.m-vite"
    plugins: [preBundlePlugin(deps)],
  });
  console.log("éœ€è¦æ„å»ºçš„ä¾èµ–é¡¹", deps);
}
```

æˆ‘ä»¬å¼€å§‹åˆ†æè¿™ä¸ªä»£ç åšäº†å“ªäº›äº‹æƒ… ğŸ˜

build æ˜¯è°ƒç”¨ esbuild çš„buildï¼Œé‡Œé¢çš„é€‰é¡¹éƒ½è§£é‡Šä¸€ä¸‹ 
- entryPointsï¼šæ˜¯æŒ‡å…¥å£æ–‡ä»¶ 
 - bundleï¼šä½¿ç”¨è„šæœ¬æ‰“åŒ…ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ esbuild çš„ apiï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸º true
  - write: æ˜¯å¦å†™å…¥æ–‡ä»¶ï¼Œ 
  - plugins: æ’ä»¶ï¼Œè¿™é‡Œé¢æœ‰ scanPlugin å’Œ preBundlePluginï¼Œ 
  - format : æ‰“åŒ…çš„æ ¼å¼ï¼Œæˆ‘ä»¬æ‰“åŒ…çš„æ˜¯ esmoduleï¼Œæ‰€ä»¥è®¾ç½®ä¸º esm 
  - splitting: æ˜¯å¦æ‹†åˆ†æ‰“åŒ…ï¼Œæˆ‘ä»¬é€‰æ‹©æ‹†åˆ†ï¼Œæ‹†åˆ†åä»£ç å—æ›´å°ï¼Œé€Ÿåº¦ä¼šæå‡ä¸€äº› 
  - outdirï¼šæ‰“åŒ…åè¾“å‡ºçš„ç›®å½•

é¢„æ„å»ºä¸ºä»€ä¹ˆæ˜¯ä¸¤æ¬¡build

1.ç¬¬ä¸€æ¬¡buildä¸è¿›è¡Œæ‰“åŒ…ï¼Œå¿«é€Ÿçš„å°†å…¶ä¾èµ–é¡¹è¿‡æ»¤å‡ºæ¥
2.ç¬¬äºŒæ¬¡buildä¸“é—¨å¯¹ç¬¬ä¸€æ¬¡è¿‡æ»¤å‡ºæ¥çš„ä¾èµ–é¡¹è¿›è¡Œæ‰“åŒ…ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æ‰€æœ‰çš„å¤–éƒ¨ä¾èµ–æƒ³çš„åŒ…

é€šä¿—çš„è®²å°±æ˜¯ç¬¬ä¸€ä¸ªbuildå°±æ˜¯lolçš„é€‰æ‹©è‹±é›„ï¼Œç¬¬äºŒéƒ¨å°±æ˜¯é€‰æ‹©å¤©èµ‹ å¬å”¤å¸ˆæŠ€èƒ½å…¨éƒ¨å¸¦å¥½ï¼Œå‡†å¤‡è¿›å…¥å¬å”¤å¸ˆå³¡è°·å¤§æ€å››æ–¹ ğŸ˜

ä¸Šé¢ä¸¤ä¸ªæ’ä»¶ä¼šåœ¨ä¸‹é¢å•ç‹¬è§£æï¼Œå…ˆç»™å¤§å®¶è¯´è¯´æ˜¯å¹²å˜›çš„ï¼Œ

- scanPlugin åšçš„äº‹æƒ…æ˜¯æ‰«æä¾èµ–ï¼Œå°† bare import è¿›è¡Œæ”¶é›† å°†ä»–æ”¾åˆ°**deps çš„ Set é›†åˆ**ä¸­;
- preBundlePlugin çš„ä½œç”¨æ˜¯ï¼Œå°†æ”¶é›†åˆ°çš„ä¾èµ–è¿›è¡Œé¢„æ„å»ºï¼Œå°†ç»“æœ**å†™å…¥åˆ°.vite æ–‡ä»¶å¤¹**ä¸­ï¼ŒåŒæ—¶**è¿”å›ä¸€ä¸ª mapï¼Œè¿™ä¸ª map ä¸­åŒ…å«äº†æ‰€æœ‰çš„ä¾èµ–çš„ç»å¯¹è·¯å¾„**ï¼Œåé¢ä¼šç”¨åˆ°ã€‚å¯¼å‡ºè§„èŒƒæ˜¯ esmodule æ¨¡å—ã€‚å¹¶ä¸”æˆ‘ä»¬ä¼šå¯¹å…¶çš„å¯¼å‡ºè¿›è¡Œé‡å†™ï¼Œ**å°† commomjs æ¨¡å—é‡å†™ä¸ºå¤§å®¶ç†ŸçŸ¥çš„ esmodule æ¨¡å—**


è¿™ä¸¤ä¸ªæ’ä»¶è·‘å®Œåï¼Œæˆ‘ä»¬çš„é¢„æ„å»ºåŸºæœ¬å°±å®Œæˆäº†

#### 5-3-1ã€å…ˆæ¥çœ‹çœ‹ sanPlugin çš„ä»£ç 

åœ¨ä¸¤ä¸ªæ’ä»¶ä¸­ï¼Œæˆ‘ä»¬æ¶‰åŠåˆ°æœ€åŸºç¡€çš„ä¸¤ä¸ªå‡½æ•°ï¼Œ**resolveId**å’Œ**load**ï¼Œä»–ä»¬æ˜¯ esbuild æ’ä»¶çš„åŸºæœ¬é’©å­

- onResolveï¼šåœ¨æ¨¡å—è·¯å¾„è¢«è§£æä¹‹å‰è°ƒç”¨ï¼Œç”¨äºä¿®æ”¹æˆ–é‡å®šå‘æ¨¡å—è·¯å¾„ã€‚
- onLoadï¼šåœ¨æ¨¡å—è·¯å¾„ç¡®å®šåè°ƒç”¨ï¼Œç”¨äºè¯»å–æˆ–ç”Ÿæˆæ¨¡å—å†…å®¹ã€‚
  åœ¨å†™çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œresolve ä¸­çš„è¿”å›å€¼è‡³å…³é‡è¦ï¼Œæˆ‘ä»¬éœ€è¦è¿”å›åŸæ¥çš„è·¯å¾„ï¼Œä»¥ä¿è¯æˆ‘ä»¬èƒ½å¤Ÿç»§ç»­è¿›è¡Œä¸‹å»
  ä»¥ä¸‹æ˜¯ scanPlugin æ’ä»¶çš„ä»£ç 

```ts
// node/contants.ts
export const EXTERNAL_TYPES = [
  "css",
  "less",
  "sass",
  "scss",
  "styl",
  "stylus",
  "pcss",
  "postcss",
  "vue",
  "svelte",
  "marko",
  "astro",
  "png",
  "jpe?g",
  "gif",
  "svg",
  "ico",
  "webp",
  "avif",
];
export const BARE_IMPORT_RE = /^[\w@][^:]/;
//optimizer/scanPlugin.ts
import { Plugin } from "esbuild";
import { BARE_IMPORT_RE, EXTERNAL_TYPES } from "../contants";
export function scanPlugin(deps: Set<string>): Plugin {
  return {
    name: "scan-deps",
    setup(build) {
      build.onResolve({ filter: new RegExp(`\\.(${EXTERNAL_TYPES.join("|")})$`) }, resolveInfo => {
        return {
          path: resolveInfo.path,
          // æ‰“ä¸Š external æ ‡è®°
          external: true,
        };
      });
      build.onResolve(
        {
          filter: BARE_IMPORT_RE,
        },
        resolveInfo => {
          deps.add(resolveInfo.path);
          return {
            path: resolveInfo.path,
            external: true,
          };
        }
      );
    },
  };
}
```

build.onResolve é’©å­ï¼Œåœ¨è§£æè·¯å¾„ä¹‹å‰è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒonResolve ä¸­çš„ filter é€‰é¡¹æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¼šæ ¹æ®æ­£åˆ™è¿›è¡Œè¿‡æ»¤

ç¬¬ä¸€ä¸ªé’©å­ä¸­ æˆ‘ä»¬è¿‡æ»¤æ‰äº†æ— å…³çš„èµ„æºï¼Œä»–æ˜¯å°† EXTERNAL_TYPES æ•°ç»„ä¸­æ‰€æœ‰ç›¸å…³çš„åç¼€åå…¨éƒ¨è¿‡æ»¤æ‰ï¼Œ è¿”å›å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è¿”å› pathï¼Œè¿™ä¸ª path æ˜¯å¿…ä¼ çš„

> path å­—æ®µç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ¨¡å—ã€‚esbuild éœ€è¦ä¸€ä¸ªæ˜ç¡®çš„è·¯å¾„æ¥ç¡®å®šæ¨¡å—çš„èº«ä»½ï¼Œä»¥ä¾¿åœ¨åç»­çš„æ„å»ºè¿‡ç¨‹ä¸­æ­£ç¡®åœ°å¤„ç†å’Œå¼•ç”¨è¯¥æ¨¡å—ã€‚

> external å­—æ®µï¼Œå¤–éƒ¨èµ„æºä¸éœ€è¦ esbuild å¯¹å…¶è¿›è¡Œå¤„ç†

æˆ‘ä»¬åœ¨è¿™ä¸¤ä¸ªé’©å­ä¸­ï¼Œç¬¬ä¸€ä¸ªé’©å­çš„ä»»åŠ¡æ˜¯æ’é™¤ä¸å¿…è¦èµ„æºï¼Œä¾¿äºä¸‹é¢çš„é’©å­èƒ½å¤Ÿæ›´å¥½çš„è§£æç”Ÿæˆä¾èµ–ï¼Œç¬¬äºŒä¸ªé’©å­æ˜¯è¿‡æ»¤å‡º æ¡ä»¶ä¸º`/^[\w@][^:]/`çš„ä¾èµ–ã€‚`ç¬¬ä¸€ä¸ªå­—ç¬¦å¿…é¡»æ˜¯å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ (_) æˆ–è€… @ã€‚è¿™ç”± [\\w@] éƒ¨åˆ†è¡¨ç¤º`,`ç¬¬äºŒä¸ªå­—ç¬¦ä¸èƒ½æ˜¯å†’å· (:)ã€‚è¿™ç”± [^:] éƒ¨åˆ†è¡¨ç¤º`ï¼Œå°†`bare import`å…¨éƒ¨æ”¶é›†åˆ°æˆ‘ä»¬ä¾èµ–é›†åˆä¸­ã€‚

#### 5-3-2ã€å†æ¥çœ‹çœ‹ preBundlePlugin çš„ä»£ç 

è¿™ä½æ›´æ˜¯é‡é‡çº§ï¼Œä¸Šå¼ºåº¦äº†å“¦ ğŸ¥µ,æˆ‘å·²ç»æ±—æµæµƒèƒŒäº†ã€‚

```ts
//optimizer/preBundlePlugin.ts
import { Loader, Plugin } from "esbuild";
import { BARE_IMPORT_RE } from "../contants";
import { init, parse } from "es-module-lexer";
import path from "path";
import resolve from "resolve";
import fs from "fs-extra";
import { pathToFileURL } from "url"
import createDebug from "debug";
import { normalizePath } from "../utils";
const debug = createDebug("dev");
export function preBundlePlugin(deps: Set<string>): Plugin {
  return {
    name: "esbuild:pre-bundle",
    setup(build) {

      build.onResolve(
        {
          filter: BARE_IMPORT_RE,
        },
        (resolveInfo) => {

          const { path: id, importer } = resolveInfo;
          const isEntry = !importer;
          // å‘½ä¸­éœ€è¦é¢„ç¼–è¯‘çš„ä¾èµ–;

          if (deps.has(id)) {

            // console.log("id", id, isEntry, importer)
            // è‹¥ä¸ºå…¥å£ï¼Œåˆ™æ ‡è®° dep çš„ namespace

            return isEntry
              ? {
                path: id,
                namespace: "dep",
              }
              : {
                // å› ä¸ºèµ°åˆ° onResolve äº†ï¼Œæ‰€ä»¥è¿™é‡Œçš„ path å°±æ˜¯ç»å¯¹è·¯å¾„äº†
                path: resolve.sync(id, { basedir: process.cwd() }),
              };
          }
        }
      );
      build.onLoad({
        filter: /.*/,
        namespace: "dep"
      }, async (loadInfo) => {
        await init;
        const id = loadInfo.path;

        const root = process.cwd();
        const entryPath = normalizePath(resolve.sync(id, { basedir: root }));

        const code = await fs.readFile(entryPath, "utf-8");
        // console.log("path-------", entryPath,)
        const [imports, exports] = await parse(code);
        // console.log("imports, exports", imports, exports)
        let proxyModule = [];
        let relativePath = normalizePath(path.relative(root, entryPath))
        if (
          !relativePath.startsWith('./') &&
          !relativePath.startsWith('../') &&
          relativePath !== '.'
        ) {
          relativePath = `./${relativePath}`
        }

        //è¿›è¡Œè¯æ³•è§£æï¼Œå°†æ‰€æœ‰requireçš„æ–‡ä»¶æ–¹æ³•æå–å‡ºæ¥è½¬ä¸ºesè™šæ‹Ÿæ¨¡å—æš´éœ² 
        if (!imports.length && !exports.length) {
          let res = await import(pathToFileURL(entryPath).toString());
          const specifiers = Object.keys(res);
          proxyModule.push(
            `export { ${specifiers.join(",")} } from "${relativePath}"`,
            // `export default import("${relativePath}")`
          );
        } else {
          if ((exports as any).includes("default")) {
            proxyModule.push(`import d from "${entryPath}";export default d`);
          }
          proxyModule.push(`export * from "${relativePath}"`);
        }


        debug("ä»£ç†æ¨¡å—å†…å®¹: %o", proxyModule.join("\n"));
        const loader = path.extname(entryPath).slice(1);
        // console.log("resolveDir----------", root, proxyModule)
        // console.log("proxyModule----------", proxyModule)
        return {
          loader: loader as Loader,
          contents: proxyModule.join("\n"),
          resolveDir: root,
        }
      })
      build.onStart(() => {
        console.log('build started')
      })
    }
  }
}
```

æˆ‘ä»¬å°†å…¶åˆ†æˆä¸¤å—æ¥çœ‹ ğŸ« 

åœ¨ onResolve ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­æ²¿ç”¨ä¸Šä¸€æ¬¡è¿›è¡Œä¾èµ–æ”¶é›†çš„æ¡ä»¶ï¼Œå…¶å®è¿›è¡Œä¾èµ–æ”¶é›†ä¹Ÿæ˜¯ä¸ºäº†èƒ½æ›´å¿«çš„æ‰¾åˆ°ä¾èµ–ï¼Œ**esbuild åœ¨ä¸æ‰“åŒ…çš„æƒ…å†µä¸‹ï¼Œé€Ÿåº¦è¿œå¿«äºéœ€è¦æ‰“åŒ…çš„æƒ…å†µ**ã€‚è®©æˆ‘ä»¬æ¥åº·åº·ï¼Œä»–æ˜¯å¦‚ä½•è¿›è¡Œç²¾å‡†å‘½ä¸­çš„

ç¬¬ä¸€æ­¥ï¼Œç¡®å®šå…¥å£æ¨¡å— ğŸ‘»
ä¸€èˆ¬æ¥è¯´ï¼ŒåŒ…é‡Œé¢å¯¹å…¶æ²¡æœ‰å¼•ç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬å°±å¯ä»¥**ç¡®è®¤ä»–æ˜¯å…¥å£æ¨¡å—ï¼ŒisEntry ä¸º true çš„è¯ï¼Œæˆ‘ä»¬ä¼šè®©ä»–åœ¨ onLoad ä¸­è¿›è¡Œè¿›ä¸€æ­¥å¤„ç†**ã€‚å¦‚æœä¸º falseï¼Œåˆ™è¿”å›å…¶è·¯å¾„ä¸ºç»å¯¹è·¯å¾„ã€‚
æˆ‘ä»¬æ¥çœ‹çœ‹å½“ä»–ä¸º false æ—¶çš„æƒ…å†µ

```js
resolveInfo = {
  path: "react",
  importer:
    "D:\\code\\study\\vite\\minivite\\koaVite\\node_modules\\.pnpm\\react-dom@18.3.1_react@18.3.1\\node_modules\\react-dom\\cjs\\react-dom.development.js",
  namespace: "file",
  resolveDir:
    "D:\\code\\study\\vite\\minivite\\koaVite\\node_modules\\.pnpm\\react-dom@18.3.1_react@18.3.1\\node_modules\\react-dom\\cjs",
  kind: "require-call",
  pluginData: undefined,
  with: {},
};
```

è¿™ä¸ªæ˜¯ä»–çš„ resolveInfoï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä»–æ˜¯åœ¨ react-dom ä¸­ä½¿ç”¨çš„ react åŒ…ï¼Œæˆ‘ä»¬æ˜¯ä¸éœ€è¦å°†å…¶è¿›è¡Œå¤„ç†çš„ï¼Œæˆ‘ä»¬åŸæœ¬å·²ç»å¤„ç†å¥½äº†ä¸€ä¸ªæ¨¡å—äº†ï¼Œè¿™é‡Œæˆ‘ä»¬**åªéœ€è¦å°†ä»–çš„è·¯å¾„è¿”å›ä¸ºæˆ‘ä»¬å½“å‰åŒ…çš„è·¯å¾„å³å¯**,ä½¿ç”¨ä»–çš„æ—¶å€™ä¼šåœ¨åç»­çš„æ’ä»¶å®¹å™¨ä¸­è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬çš„æ’ä»¶æœ€ç»ˆä¼šåœ¨.m-viteä¸­å»è¯»å–bareåŒ…

ç¬¬äºŒæ­¥ï¼Œå¯¹äºå…¥å£æ–‡ä»¶è¿›è¡Œé‡å†™ ğŸ’€
ä¸Šè¿°æ»¡è¶³æ¡ä»¶çš„ä¼šæ ‡è®°ä¸º dep å‘½åç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨**åªç”¨ç›¸åŒçš„å‘½åç©ºé—´è·å–ä¸Šæ–‡ä¸­è¿‡æ»¤å‡ºæ¥çš„æ¨¡å—**ã€‚
`es-module-lexer`è¿™ä¸ªåŒ…æ˜¯ç”¨äºå¯¹è·¯å¾„ä¾èµ–è¿›è¡Œåˆ†æçš„ï¼Œæˆ‘ä»¬**await init å®é™…ä¸Šå°±ç›¸å½“äºå°†å…¶å¤„äºäº† init.then()çš„ç¯å¢ƒä¸‹**ï¼Œæˆ‘ä»¬ä» loadInfo ä¸­è·å–å½“å‰è·¯å¾„çš„ id ï¼Œç„¶å**ä½¿ç”¨ resolve.sync å’Œ normalizePath,å°†å…¶è½¬æ¢ä¸ºå¯ç”¨çš„è·¯å¾„**

```ts
export function normalizePath(id: string): string {
  return path.posix.normalize(isWindows ? slash(id) : id);
}
```

è¿™ä¸ªæ–¹æ³•åªæ˜¯å¸®æˆ‘ä»¬é€‚é… windows ç³»ç»Ÿçš„è·¯å¾„ï¼Œresolve.sync æ˜¯**å°†å¦‚`react`è¿™ç§è·¯å¾„ï¼Œæ‹¼æ¥æˆç»å¯¹è·¯å¾„**,resolve æ˜¯å¸®åŠ©æˆ‘ä»¬ä»å½“å‰æ ¹è·¯å¾„ä¸‹å¯»æ‰¾å¯ç”¨çš„è·¯å¾„ã€‚ä»–ä»¬ä¼šå°† id ä¸º`react`,è½¬åŒ–ä¸º`"D:/code/study/vite/minivite/koaVite/node_modules/react/index.js"`è¿™æ ·çš„è·¯å¾„

`await parse(code)`ï¼Œè§£æå½“å‰è·¯å¾„æ˜¯å¦å­˜åœ¨**å¼•å…¥å’Œå¯¼å‡º**ï¼Œ`proxyModule`æ­¤æ•°ç»„ç”¨æ¥æ”¶é›†**ä¾èµ–**ï¼Œ`relativePath`åˆ™æ˜¯å°†è·¯å¾„è½¬åŒ–ä¸º`"./node_modules/react-dom/index.js"`è¿™ç§ç›¸å¯¹è·¯å¾„ï¼Œä¸‹é¢çš„ if å¤„ç†ä¹Ÿæ˜¯ç”¨äºå¸®åŠ©è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„çš„ã€‚

```ts
await init;
const id = loadInfo.path;

const root = process.cwd();
const entryPath = normalizePath(resolve.sync(id, { basedir: root }));

const code = await fs.readFile(entryPath, "utf-8");
// console.log("path-------", entryPath,)
const [imports, exports] = await parse(code);
// console.log("imports, exports", imports, exports)
let proxyModule = [];
let relativePath = normalizePath(path.relative(root, entryPath));
if (!relativePath.startsWith("./") && !relativePath.startsWith("../") && relativePath !== ".") {
  relativePath = `./${relativePath}`;
}
```

æˆ‘ä»¬å¼€å§‹å¤„ç†æ˜¯å¦å­˜åœ¨ esmodule ä¾èµ–äº†,`if (!imports.length && !exports.length) `è¿™é‡Œçš„å¤„ç†æ˜¯**åˆ¤æ–­æˆ‘ä»¬æ˜¯å¦å­˜åœ¨æœ‰ es æ¨¡å—æ„ç­‘çš„åŒ…**ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å°† commonjs çš„æ¨¡å—è½¬æ¢ä¸º esmodule çš„æ¨¡å—ï¼Œæˆ‘ä»¬**é€šè¿‡ import å…ˆè·å–å¯¹åº”æ–‡ä»¶çš„å¯¼å‡ºæ¨¡å—**ï¼Œæˆ‘ä»¬çš„å…¥å£æ–‡ä»¶ä¸»è¦åŠŸèƒ½å°±æ˜¯æš´éœ²æ¨¡å—ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨æš´éœ²äº†å“ªäº›æ¨¡å—å°±å¥½äº†ï¼Œæœ€åä¼š**å°†åŒä¸€ä¸ªå‘½åç©ºé—´ä¸‹ä¸åŒçš„å¯¼å‡ºæ¨¡å—æ±‡æ€»åˆ°ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªæ•°ç»„**;

> importå¼‚æ­¥æ–¹æ³•å¯ä»¥ç›´æ¥å°†requireçš„æ¨¡å—å˜æˆesæ¨¡å—ï¼Œéå¸¸å¥½ç”¨ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨pathToFileURL è¿™ä¸ªnodeåŸç”Ÿçš„æ–¹æ³•ï¼Œå°†å…¶è·¯å¾„å˜åŒ–ä¸ºæ–‡ä»¶è·¯å¾„

```ts
//è¿›è¡Œè¯æ³•è§£æï¼Œå°†æ‰€æœ‰requireçš„æ–‡ä»¶æ–¹æ³•æå–å‡ºæ¥è½¬ä¸ºesè™šæ‹Ÿæ¨¡å—æš´éœ²
if (!imports.length && !exports.length) {
  const res = require(entryPath);

  const specifiers = Object.keys(res);
  // console.log("res----", entryPath, res)
  proxyModule.push(
    `export { ${specifiers.join(",")} } from "${relativePath}"`,
    `export default require("${relativePath}")`
  );
} else {
  if ((exports as any).includes("default")) {
    proxyModule.push(`import d from "${entryPath}";export default d`);
  }
  proxyModule.push(`export * from "${relativePath}"`);
}
```

æˆ‘ä»¬çš„ elseï¼Œåˆ™æ˜¯å­˜åœ¨ esmodule æ¨¡å—æ—¶çš„æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰é»˜è®¤æš´éœ²ï¼Œæœ‰çš„è¯å°±è¡¥ä¸Šï¼Œåœ¨åˆ†åˆ«æš´éœ²çš„æƒ…å†µä¸‹ä¹Ÿåªéœ€è¦ä½¿ç”¨é€šé…ç¬¦å°±å¯ä»¥æš´éœ²æ‰€æœ‰æ¨¡å—ï¼Œéå¸¸æ–¹ä¾¿

ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå¤„ç†å‘¢

å¯¹äº CommonJS æ ¼å¼çš„ä¾èµ–ï¼Œå•çº¯ç”¨ export default require('å…¥å£è·¯å¾„') æ˜¯æœ‰å±€é™æ€§çš„ï¼Œæ¯”å¦‚å¯¹äº React è€Œè¨€ï¼Œç”¨è¿™æ ·çš„æ–¹å¼ç”Ÿæˆçš„äº§ç‰©æœ€ååªæœ‰ default å¯¼å‡º:

```ts
export default react_default;
```

é‚£ä¹ˆç”¨æˆ·åœ¨ä½¿ç”¨è¿™ä¸ªä¾èµ–çš„æ—¶å€™ï¼Œå¿…é¡»è¿™ä¹ˆä½¿ç”¨:

```ts
// âœ… æ­£ç¡®
import React from "react";
const { useState } = React;
// âŒ æŠ¥é”™
import { useState } from "react";
```

æœ€å,è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œloader è¿™é‡Œæ˜¯'js'ï¼Œå°†æˆ‘ä»¬çš„å†…å®¹æ‰“åŒ…ä¸º jsï¼Œ` proxyModule.join("\n")`å°†æ”¶é›†çš„ä¾èµ–æ•°ç»„è½¬åŒ–ä¸ºå†…å®¹ï¼Œä»£æ›¿åŸæœ¬çš„å†…å®¹è¿›è¡Œæ‰“åŒ…ï¼ŒresolveDir åˆ™æ˜¯æˆ‘ä»¬å½“å‰æ ¹ç›®å½•

```ts
const loader = path.extname(entryPath).slice(1);
// console.log("resolveDir----------", root, proxyModule)
// console.log("proxyModule----------", proxyModule)
return {
  loader: loader as Loader,
  contents: proxyModule.join("\n"),
  resolveDir: root,
};
```

ä¸‹é¢åˆ™æ˜¯æˆ‘ä»¬æ‰“åŒ…çš„ç»“æœ

```js
// dep:react
var import_react = __toESM(require_react());
var export_Children = import_react.Children;
var export_Component = import_react.Component;
var export_Fragment = import_react.Fragment;
var export_Profiler = import_react.Profiler;
var export_PureComponent = import_react.PureComponent;
var export_StrictMode = import_react.StrictMode;
var export_Suspense = import_react.Suspense;
var export___SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED = import_react.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;
var export_act = import_react.act;
var export_cloneElement = import_react.cloneElement;
var export_createContext = import_react.createContext;
var export_createElement = import_react.createElement;
var export_createFactory = import_react.createFactory;
var export_createRef = import_react.createRef;
var export_default = import_react.default;
var export_forwardRef = import_react.forwardRef;
var export_isValidElement = import_react.isValidElement;
var export_lazy = import_react.lazy;
var export_memo = import_react.memo;
var export_startTransition = import_react.startTransition;
var export_unstable_act = import_react.unstable_act;
var export_useCallback = import_react.useCallback;
var export_useContext = import_react.useContext;
var export_useDebugValue = import_react.useDebugValue;
var export_useDeferredValue = import_react.useDeferredValue;
var export_useEffect = import_react.useEffect;
var export_useId = import_react.useId;
var export_useImperativeHandle = import_react.useImperativeHandle;
var export_useInsertionEffect = import_react.useInsertionEffect;
var export_useLayoutEffect = import_react.useLayoutEffect;
var export_useMemo = import_react.useMemo;
var export_useReducer = import_react.useReducer;
var export_useRef = import_react.useRef;
var export_useState = import_react.useState;
var export_useSyncExternalStore = import_react.useSyncExternalStore;
var export_useTransition = import_react.useTransition;
var export_version = import_react.version;
export {
  export_Children as Children,
  export_Component as Component,
  export_Fragment as Fragment,
  export_Profiler as Profiler,
  export_PureComponent as PureComponent,
  export_StrictMode as StrictMode,
  export_Suspense as Suspense,
  export___SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED as __SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,
  export_act as act,
  export_cloneElement as cloneElement,
  export_createContext as createContext,
  export_createElement as createElement,
  export_createFactory as createFactory,
  export_createRef as createRef,
  export_default as default,
  export_forwardRef as forwardRef,
  export_isValidElement as isValidElement,
  export_lazy as lazy,
  export_memo as memo,
  export_startTransition as startTransition,
  export_unstable_act as unstable_act,
  export_useCallback as useCallback,
  export_useContext as useContext,
  export_useDebugValue as useDebugValue,
  export_useDeferredValue as useDeferredValue,
  export_useEffect as useEffect,
  export_useId as useId,
  export_useImperativeHandle as useImperativeHandle,
  export_useInsertionEffect as useInsertionEffect,
  export_useLayoutEffect as useLayoutEffect,
  export_useMemo as useMemo,
  export_useReducer as useReducer,
  export_useRef as useRef,
  export_useState as useState,
  export_useSyncExternalStore as useSyncExternalStore,
  export_useTransition as useTransition,
  export_version as version
};

```

export*useRef ä¸­é—´åŠ ä¸€ä¸ª*ä»£è¡¨ä¹‹å‰æ˜¯ commomjs çš„æ¨¡å—ï¼Œç°åœ¨å˜æˆ esmodule çš„æ¨¡å—ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸€ä¸ª\_,åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ä¾èµ–é¢„æ„å»ºç»ˆäºå®Œæˆäº†ï¼›

å‚è€ƒï¼š

<a href="https://s.juejin.cn/ds/iDy3m2f9/">æ·±å…¥æµ…å‡ºvite</a>


å¤§å®¶å¯ä»¥å»å­¦ä¸€å­¦è¿™ä¸ªï¼Œæ­¤é¡¹ç›®çš„çµæ„Ÿæ¥æºï¼Œä¹Ÿæ˜¯å¸¦æˆ‘è¿›å…¥äº†å·¥ç¨‹åŒ–çš„å¤§é—¨