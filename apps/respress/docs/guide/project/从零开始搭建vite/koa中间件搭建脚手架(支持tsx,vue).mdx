# koa ä¸­é—´ä»¶æ­å»ºè„šæ‰‹æ¶(æ”¯æŒ tsx,vue)

## ç”¨ 100 è¡Œä»£ç ï¼Œç”¨ koa å†™ä¸€ä¸ªæ”¯æŒ vue å’Œ react çš„èµ›åšè„šæ‰‹æ¶ ğŸ˜¼

å¦‚ä½•æœ‰æ•ˆçš„ä¿è¯ä¸æŒ‚ç§‘ï¼Œå½“ç„¶æ˜¯èƒŒçŸ¥è¯†ç‚¹å•¦ï¼›ğŸ˜
åŒç†ï¼Œå¦‚ä½•å»ç†è§£è„šæ‰‹æ¶å‘¢ï¼Œæˆ‘çš„ç†è§£æ˜¯ä»¥æœ€ä½é™åº¦çš„å¯ç”¨æ€§ï¼Œå»æ­å»ºä¸€ä¸ªè„šæ‰‹æ¶ï¼Œè®©æˆ‘ä»¬æ”¾å¼ƒå“ªäº›åå¤çš„é’©å­ï¼Œpluginï¼Œä»¥åŠä¸€äº›å…¶ä»–çš„é…ç½®ã€‚æˆ‘ä¼šåœ¨ä¸€ä¸ªä¸­é—´ä»¶ä¸­ï¼Œæ¥å®Œæˆæœ€ä½é™åº¦çš„è§£æä»£ç çš„å·¥ä½œï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶å»ç†è§£è„šæ‰‹æ¶ï¼Œæ­¤é¡¹ç›®å‚è€ƒäº mini-vite å’Œ vite-plugin-vueï¼›

æˆ‘ä»¬ vite ä¹Ÿæœ‰è‡ªå·±çš„åƒåœ¾ä½¬

è¿™ä¸ªé¡¹ç›®æ˜¯æˆ‘åœ¨å†™ miniVite çš„æ—¶å€™äº§ç”Ÿçš„æƒ³æ³•ï¼Œæ‰€ä»¥ç”¨çš„æ˜¯åŒä¸€ä¸ªåº“ï¼Œè®¤å‡†`npm run cyber`,å°±å¥½äº†;

è¿™ä¸ªæ˜¯ä»“åº“åœ°å€ï¼Œæ—¢ç„¶æ¥éƒ½æ¥äº†ï¼Œç»™ä¸ª star å§

<img src="https://memeprod.ap-south-1.linodeobjects.com/user-template/a1e08e595e29eef80af9737fefd90d21.png" />

[![Readme Card](https://github-readme-stats.vercel.app/api/pin/?username=Manshawar&repo=koa_vite)](https://github.com/Manshawar/koa_vite)

è¿™é‡Œæ˜¯ç›®å½•ç»“æ„,ä»¥ä¸‹æ˜¯å’Œå½“å‰é¡¹ç›®ç›¸å…³çš„ï¼Œä¸“æ³¨äºè¿™äº›æ–‡ä»¶å°±å¥½

```json
|-- koaMinivite,
      |-- .gitignore,
      |-- cyber.html,
      |-- ...,
      |-- src,
          |-- cyber.ts,
          |-- cyber,
          |   |-- a.ts,
          |   |-- App.vue,
          |   |-- help.js,
          |   |-- react.tsx,
          |   |-- vue.ts,
          |-- ...,
          |-- node,
              |-- ...,
              |-- optimizer,
              |   |-- index.ts,
              |   |-- preBundlePlugin.ts,
              |   |-- scanplugin.ts,


```

### ä¸€ã€koa æ­å»º

é¦–å…ˆæ¥çœ‹æˆ‘ä»¬çš„å…¥å£æ–‡ä»¶`cyber.ts`;è¿™ä¸ªæ–‡ä»¶æ˜¯æ ¸å¿ƒæ–‡ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»–åšäº†ä»€ä¹ˆï¼›

```ts
import Koa from "koa";
import { optimize } from "./node/optimizer";
const app = new Koa();
app.use(async (ctx, next) => {
  //ä¸­é—´ä»¶åŒºåŸŸ
  return next();
});
app.listen(8954, async () => {
  await optimize(root, "src/cyber/react.tsx");
  await optimize(root, "src/cyber/vue.ts");
  console.log("http://localhost:8954 ");
});
```

### äºŒã€é¢„æ„å»º

æˆ‘ä»¬çœ‹åˆ°`app.listen`å¼€å¯æœåŠ¡çš„æ—¶å€™ä¸ºä»€ä¹ˆä¼šåœ¨å›è°ƒä¸­å¤„ç†ä¸€ä¸ª optimize çš„å‡½æ•°å‘¢ï¼›
æˆ‘ä»¬å¯¹ä»£ç ä¼šè¿›è¡Œä¸€ä¸ªé¢„æ„å»ºï¼›è¯¦ç»†çš„è§£é‡Šè¯·ç§»æ­¥ <a href="https://juejin.cn/post/7442189493153579046">ä» koa åˆ° mini-vite</a> ;
æˆ‘ç°åœ¨å¯¹å…¶è¿›è¡Œä¸€ä¸ªé€šä¿—çš„è§£é‡Š
è¿™é‡Œæ˜¯ react åŒ…çš„ index.js

```js
"use strict";
if (process.env.NODE_ENV === "production") {
  module.exports = require("./cjs/react.production.min.js");
} else {
  module.exports = require("./cjs/react.development.js");
}
```

<p>é‚£ä¹ˆä½ æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªé—®é¢˜ï¼›æˆ‘ä»¬å¸¸ä½¿ç”¨çš„å¼•å…¥æ–¹æ³•æ˜¯`import React from "react";`</p>
è¿™æ˜¯ä¸¤ç§æ¨¡å—ç±»å‹ï¼Œä¸€ä¸ªæ˜¯esmï¼Œä¸€ä¸ªæ˜¯cjsï¼›å°±åƒå¤©å ‚çš„ç™½é¸½ä¸ä¼šäº²å»ç”°é‡çš„ä¹Œé¸¦ï¼Œesæ¨¡å—ä¹Ÿä¸ä¼šå¼•å…¥cjsæ¨¡å—ï¼› ä½ æ‹¿å‰æœçš„ğŸ—¡ï¼Œæ€ä¹ˆèƒ½æ–©æœ¬æœçš„å®˜
<img src="https://th.bing.com/th/id/OIP.99MBNn0mDCjAAELdfV29fAHaEL?rs=1&pid=ImgDetMain" />

é‚£æˆ‘ä»¬è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜

- æ€ä¹ˆè®©å„ä¸ªåŒ…çš„æ¨¡å—æ ¼å¼éƒ½è½¬åŒ–ä¸º esm æ¨¡å—
- node_modules åŒ…é‡Œçš„æ–‡ä»¶è¿™ä¹ˆå¤šï¼Œéš¾é“æˆ‘ä»¬è¦å…¨éƒ¨ä»£ç†æˆé™æ€èµ„æºæœåŠ¡å™¨å—
- å¦‚ä½•è®©å¤–éƒ¨èµ„æºåŒ…å’Œç›¸å¯¹è·¯å¾„æ–‡ä»¶è¿›è¡ŒåŒºåˆ†

esbuild å¯ä»¥é€šè¿‡æ‰“åŒ…æ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œæœ‹å…‹é£çš„è§£é‡Šï¼š ä¸æ‰“ç°æ€ä¹ˆæµ‡ç­‘æ··å‡åœŸï¼›
æˆ‘ä»¬çš„ç›®çš„æ˜¯æƒ³è¦å°†æ‰€æœ‰è¦ç”¨çš„åŒ…ï¼Œå¯ä»¥ç†è§£æˆåé¢ç Œç –éœ€è¦å¤šå°‘æ°´æ³¥ï¼Œéƒ½æ‹–åˆ°å·¥åœ°ä¸Šæ¥ï¼›æ‰¾ä¸ªåœ°æ–¹ï¼ŒæŠŠä»–ä»¬æ”¾å“ªé‡Œè®©æˆ‘ä»¬å¥½ä½¿ç”¨ï¼Œ

è¿™ä¸ªæ–‡ä»¶æ˜¯ nodemodule åŒ…ä¸­çš„.vite æ–‡ä»¶ï¼Œä½ å¯ä»¥å»ä»»ä½•ä¸€ä¸ª vite é¡¹ç›®ä¸­å»å¯»æ‰¾ä»–ï¼Œæˆ‘ä»¬è¿™é‡Œæ”¹ä¸€ä¸‹åå­—,å°±å«".m-vite"ï¼›

è¿™é‡Œæ˜¯ optimizer çš„ä»£ç 

```ts
import path from "path";
import { build } from "esbuild";
import { scanPlugin } from "./scanplugin";
import { preBundlePlugin } from "./preBundlePlugin";
import { PRE_BUNDLE_DIR } from "../contants";
export async function optimize(root: string, other?: string) {
  // 1. ç¡®å®šå…¥å£
  // 2. ä»å…¥å£å¤„æ‰«æä¾èµ–
  // 3. é¢„æ„å»ºä¾èµ–;
  const deps = new Set<string>();
  const entry = path.resolve(root, other ? other : "src/client/main.tsx");
  await build({
    entryPoints: [entry],
    bundle: true,
    write: false,
    plugins: [scanPlugin(deps)]
  });
  await build({
    entryPoints: [...deps],
    write: true,
    bundle: true,
    format: "esm",
    splitting: true,
    outdir: path.resolve(root, PRE_BUNDLE_DIR)//PRE_BUNDLE_DIR = ".m-vite",
    plugins: [preBundlePlugin(deps)]
  });
  console.log("éœ€è¦æ„å»ºçš„ä¾èµ–é¡¹", deps)
}

```

ä»–ç»å†äº†ä¸¤æ¬¡ buildï¼Œç¬¬ä¸€æ¬¡æ˜¯æ‰«æä¾èµ–ä¸ç”Ÿæˆæ–‡ä»¶ï¼Œç¬¬äºŒæ¬¡æ˜¯é¢„æ„å»ºä¾èµ–æ„å»ºä¾èµ–ï¼Œè¾“å‡ºè‡³ node_modules/.m-viteï¼Œ

è‡³äºæ’ä»¶çš„è¯¦è§£ è¯·ç§»æ­¥

<a href="https://juejin.cn/post/7442189493153579046">ä»koaåˆ°mini-vite</a>;

æˆ‘ä»¬è¿™é‡Œç»å†äº†ä¸¤æ¬¡é¢„æ„å»º

```ts
await optimize(root, "src/cyber/react.tsx");
await optimize(root, "src/cyber/vue.ts");
```

å› ä¸ºè¿™ä¸ªé¡¹ç›®ä¼šåŒæ—¶æ‰§è¡Œ react å’Œ vueï¼Œæ‰€ä»¥éœ€è¦é¢„æ„å»ºä¸¤æ¬¡ï¼Œå½“ç„¶ä½ å¯ä»¥è‡ªå·±é€‰æ‹©ï¼Œåªéœ€è¦åœ¨å…¥å£å¤„å†™ä¸Šå¯¹åº”çš„æ–‡ä»¶åå³å¯;

è¿™ä¸ªæ˜¯æˆ‘ä»¬é¢„æ„å»ºåçš„ç›®å½•

<img src="/vite/cyber/.m-vite.png" />

æ‰“åŒ…åçš„ä»–ä»¬æ”¯æŒ es æ¨¡å—è¯­æ³•äº†ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¼šå»å…¶ä¸­æå–ç›¸åº”çš„ä¾èµ–

### ä¸‰ã€ä¸­é—´ä»¶

#### transformHtml æ¸²æŸ“åˆå§‹é¡µé¢

å¼€å§‹æˆ‘ä»¬ä¸­é—´ä»¶çš„ç¬¬ä¸€æ­¥ï¼Œè®©æˆ‘ä»¬è·å–åˆ°äº† req.url åè¯¥åšä»€ä¹ˆï¼Œå½“é¡µé¢æ²¡æœ‰ä»»ä½•è·¯å¾„çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šè·å–åˆ°`req.url ="/"`ï¼Œæˆ‘ä»¬å°±åœ¨åˆå§‹è·¯å¾„ä¸‹ï¼Œç»™ä»–è¿”å›ä¸€ä¸ª html æ–‡ä»¶ï¼Œè®©é¡µé¢å»åŠ è½½ä»–

```ts
app.use(async (ctx, next) => {
  const { req, res } = ctx;
  if (req.url === "/") {
    const realPath = path.join(process.cwd(), "/cyber.html");
    //transformHtml
    if (await fs.pathExists(realPath)) {
      let code = await fs.readFile(realPath, "utf-8");
      res.setHeader("Content-Type", "text/html");
      res.end(code);
    }
  }
});
```

æˆ‘ä»¬è¿™é‡Œå»è¯»å–äº†æˆ‘ä»¬æ ¹ç›®å½•ä¸‹çš„ cyber.html æ–‡ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`fs-extra`åº“;è¿™ä¸ªåº“çš„ api åŸºæœ¬å’Œ fs åŸç”Ÿçš„ä¸€è‡´ï¼Œä½†åˆæ›´å¥½çš„æ€§èƒ½ï¼Œå’Œæ›´åŠ ä¸°å¯Œçš„ apiï¼Œæˆ‘ä»¬æ£€æµ‹æ˜¯å¦å­˜åœ¨è¯¥è·¯å¾„ï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨`utf-8`çš„æ ¼å¼å»è¯»å–ï¼Œå¹¶è®¾ç½®`text/html`çš„è¯·æ±‚å¤´è¿”å›ç»™æˆ‘ä»¬çš„æœåŠ¡å™¨ï¼›ä¸å‡ºæ„å¤–çš„è¯ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸€ä¸ª`html`é¡µé¢äº†

è¿™é‡Œæ˜¯`cyber.html`æ–‡ä»¶çš„å†…å®¹

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <div id="react"></div>
    <script type="module" src="src/cyber/react.tsx"></script>

    <div id="vue"></div>
    <script type="module" src="src/cyber/vue.ts"></script>
  </body>
</html>
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä»–ä¼šå¼•å…¥ä¸€ä¸ª react.tsx æ–‡ä»¶ï¼Œå¯æ˜¯æˆ‘ä»¬çš„æœåŠ¡å™¨è¿˜æ²¡åˆåŠæ³•å»å¤„ç†ä»–ï¼Œåˆ«æ…Œï¼Œæˆ‘ä»¬æ¥è¿›è¡Œä¸‹ä¸€æ­¥ä¸­é—´ä»¶çš„ä¹¦å†™

```ts
app.use(async (ctx, next) => {
  const { req, res } = ctx;
  if (req.url === "/") {
    const realPath = path.join(process.cwd(), "/cyber.html");
    //transformHtml
    if (await fs.pathExists(realPath)) {
      let code = await fs.readFile(realPath, "utf-8");
      res.setHeader("Content-Type", "text/html");
      res.end(code);
    }
  } else if (req.method === "GET" || /\.(?:j|t)sx?$|\.mjs$|\.vue$/.test(req.url as string)) {
    //resolve
    const realPath = path.join(process.cwd(), req.url + "");
    //loader
    if (await fs.pathExists(realPath)) {
      let code = await fs.readFile(realPath, "utf-8");
      let exname =
        path.extname(req.url as string).slice(1) === "vue"
          ? "js"
          : path.extname(req.url as string).slice(1);
      let { code: transformedCode, map } = await esbuild.transform(code, {
        target: "esnext",
        format: "esm",
        sourcemap: true,
        loader: exname as "js" | "ts" | "jsx" | "tsx",
      });
      //  transform
      const ms = new MagicString(transformedCode);
      await init;
      const [imports, exports] = parse(transformedCode);
      for (const importInfo of imports) {
        const { n: importedId, s: start, e: end } = importInfo;
        if (!importedId) continue;
        if (/^[\w@][^:]/.test(importedId)) {
          let realPath = path.join("/", "node_modules", ".m-vite", `${importedId}.js`);
          realPath = realPath.replace(/\\/g, "/");
          ms.overwrite(start, end, realPath);
          code = ms.toString();
        }
      }

      res.setHeader("Content-Type", "application/javascript");

      res.statusCode = 200;
      res.end(code);
    }
  }
  return next();
});
```

æˆ‘ä»¬æ¥è¿›è¡Œä¸‹ä¸€æ­¥çš„å¤„ç†ï¼Œè¿™ä¸ªæ˜¯ vite çš„ load é˜¶æ®µ,å»è¯»å–ç›¸åº”çš„æ–‡ä»¶

#### resolve å’Œ loader è§£ææ–‡ä»¶è·¯å¾„å¹¶è¯»å–ä»–

```ts
if (req.method === "GET" || /\.(?:j|t)sx?$|\.mjs$|\.vue$/.test(req.url as string)) {
  const realPath = path.join(process.cwd(), req.url + "");
}
```

è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬ä¸»è¦åšçš„æ˜¯ç­›é€‰å’Œæ‹¼æ¥è·¯å¾„ï¼Œæˆ‘ä»¬åªå…è®¸ js,ts,jsx,tsx,vue,mjs æ–‡ä»¶ä¼ å…¥ï¼Œæˆ‘ä»¬ä½¿ç”¨æ­£åˆ™å¯¹å…¶è¿‡æ»¤
ç„¶åå†æ‹¼æ¥å‡ºä»–çš„çœŸæ­£è·¯å¾„å‡ºæ¥ï¼›æˆ‘ä»¬ vite çš„ resolve é˜¶æ®µ å°±æ˜¯åšçš„è¿™ä¹ˆä¸€é¡¹å·¥ä½œ

æ—¢ç„¶çŸ¥é“åœ°å€äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å’Œä¸Šæ–‡ä¸­çš„ä¸€æ ·ï¼Œå»è¯»å–ä»–

```ts
if (await fs.pathExists(realPath)) {
  let code = await fs.readFile(realPath, "utf-8");
  let { code: transformedCode, map } = await esbuild.transform(code, {
    target: "esnext",
    format: "esm",
    sourcemap: true,
    loader: path.extname(req.url as string).slice(1) as "js" | "ts" | "jsx" | "tsx",
  });
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¯»å–ä»–åï¼Œä½¿ç”¨ esbuild å¯¹å…¶è¿›è¡Œäº†è½¬æ¢ï¼Œæˆ‘ä»¬è¿™ä¸€æ­¥æ˜¯å°† ts æ–‡ä»¶æˆ–è€… tsx æ–‡ä»¶è½¬æ¢ä¸º esm æ¨¡å—ï¼›å…¶ä¸­ loader æ˜¯æˆ‘ä»¬ç›®å‰æ–‡ä»¶çš„åç¼€ï¼Œ`react`çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥ç›´æ¥è¢« esbuild è§£æï¼Œå¯ä»¥å¸®æˆ‘ä»¬èŠ‚çœå¾ˆå¤šåŠŸå¤«ï¼Œ`vue`åˆ™éœ€è¦èŠ±è´¹å¤§é‡çš„ç²¾åŠ›è¿›è¡Œä¹¦å†™äº†

æˆ‘ä»¬å¾—åˆ°çš„`transformedCode`å°±æ˜¯æˆ‘ä»¬å¤„ç†å¥½çš„`tsx`æ–‡ä»¶äº†ï¼Œè¿™æ—¶å€™ä»–æ˜¯ä¸€ä¸ªåŸç”Ÿçš„ es6 æ¨¡å—ï¼›ä½†é—®é¢˜éšä¹‹è€Œæ¥

#### transform è½¬æ¢

<img src="/vite/cyber/bare.png" />

æˆ‘ä»¬çš„æµè§ˆå™¨å¯ä¸è®¤è¯†`bare`å¼•å…¥çš„åŒ…ï¼›è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ”¹å†™ï¼Œä¸Šé¢çš„é¢„æ„å»ºçš„æ–‡ä»¶å°±æœ‰äº†ç”¨æ­¦ä¹‹åœ°ï¼›

```ts
const ms = new MagicString(transformedCode);
await init;
const [imports, exports] = parse(transformedCode);
for (const importInfo of imports) {
  const { n: importedId, s: start, e: end } = importInfo;

  if (!importedId) continue;
  if (/^[\w@][^:]/.test(importedId)) {
    let realPath = path.join("/", "node_modules", ".m-vite", `${importedId}.js`);
    realPath = realPath.replace(/\\/g, "/");
    // ms.overwrite(start, end, realPath);
    code = ms.toString();
  }
}
```

æˆ‘ä»¬ä½¿ç”¨`magic-string`è¿™ä¸ªåº“`import MagicString from "magic-string";`ï¼Œ`new`ä¸€ä¸ª`ms`;å‡ºæ¥ï¼Œä»–çš„åŠŸèƒ½æ˜¯å»ä¿®æ”¹æˆ‘ä»¬çš„ä»£ç ï¼›è¿™ä¸ªåº“æ˜¯`vite`å®˜æ–¹ä½¿ç”¨çš„
ç„¶åä½¿ç”¨ `await init` åˆ›å»ºå¼•å…¥å’Œå¯¼å‡ºçš„åˆ†æç¯å¢ƒ;`import { init, parse } from "es-module-lexer";`è¿™ä¸ªå·¥å…·åº“å¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆ†æä¸€ä¸ªæ¨¡å—çš„å¯¼å…¥å¯¼å‡ºï¼Œå¹¶è¿”å›ç›¸åº”çš„`ast`;

```ts
{ n: 'react', t: 1, s: 43, e: 48, ss: 24, se: 49, d: -1, a: -1 }
{
  n: 'react-dom/client',
  t: 1,
  s: 79,
  e: 95,
  ss: 51,
  se: 96,
  d: -1,
  a: -1
}
```

è¿™ä¸ªæ˜¯æˆ‘ä»¬åˆ†æå‡ºçš„ imports çš„å€¼ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸‰ç‚¹ï¼›`n` å’Œ `s` å’Œ `e`ï¼›`n`æ˜¯åŒ…å `s`æ˜¯å¼€å§‹ä½ç½® `e`æ˜¯ç»“æŸä½ç½®;çŸ¥é“è¿™å‡ ä¸ªå€¼æˆ‘ä»¬å°±èƒ½æ”¹å†™åŸæ¥çš„ä»£ç ï¼›

```ts
let realPath = path.join("/", "node_modules", ".m-vite", `${importedId}.js`);
```

å°†ä»£ç æ”¹ä¸ºæˆ‘ä»¬æƒ³è¦çš„è·¯å¾„ï¼Œç„¶åè¿”å›å³å¯ï¼›è¿™æ˜¯åŒ…çš„ä½ç½®å°±æŒ‡å‘çš„äº†`.m-vite`æ–‡ä»¶ä¸­äº†

```js
import a from "./a.ts";
import React from "/node_modules/.m-vite/react.js";
import { createRoot } from "/node_modules/.m-vite/react-dom/client.js";
console.log(React, a);
const App = () => /* @__PURE__ */ React.createElement("div", null, "react");
const root = createRoot(document.getElementById("react"));
root.render(/* @__PURE__ */ React.createElement(App, null));
```

è¿™ä¸ªå°±æ˜¯æœ€ç»ˆè¿”å›çš„æ–‡ä»¶;esbuild åŸç”Ÿæ”¯æŒ`react`ï¼›`vue`ä¸ä¹‹ç›¸æ¯”åˆå¾ˆåäººç±»äº†;

```ts
res.setHeader("Content-Type", "application/javascript");
res.statusCode = 200;
res.end(code);
```

æœ€åå°†å…¶ä½œä¸º js æ–‡ä»¶è¿”å›ï¼Œä½ çš„ react å°±æˆäº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯å¦è¿˜é—å¿˜äº†ä¸€ä¸ªä¸œè¥¿,`vue`è¯¥æ€ä¹ˆå¤„ç†?

#### vue-loader

`vue`çš„å¤„ç†æ˜¯ä¸€æŠŠå¿ƒé…¸ï¼Œä¸€æŠŠæ³ªï¼Œä¸ºäº†å¤„ç†`vue`ï¼›è·‘å»è¯»äº†`vue-plugin`çš„æºç ï¼›

<a href="https://github.com/vitejs/vite-plugin-vue">vue-plugin</a>

å…¶ä¸­éš¾ç‚¹å°±åœ¨äº sfc æ€ä¹ˆå¤„ç†ï¼›æ€ä¹ˆè®²å•æ–‡ä»¶æ‹†åˆ†æˆä¸‰å—è¿›è¡Œå¤„ç†ï¼Œå½“ç„¶ï¼Œæˆ‘åªæ‹†äº†ä¸¤å—ï¼Œåç”Ÿï¼Œä½ å‘ç°äº†ç›²ç‚¹ã€‚æ•´ä¸ªé¡¹ç›®æ²¡æœ‰å¤„ç†`css`çš„ä¸œè¥¿ï¼Œå“ˆå“ˆ ğŸ˜„ï¼›å½“ç„¶æˆ‘ä»¬å…ˆå­¦ä¼šå¤„ç† jsï¼Œcss ä¼šå¥½å¤„ç†å¾ˆå¤š

å…ˆå ä¸ªç”²ï¼Œè¿™ä¸ª`vue-plugin`çš„é£æ ¼ä¹Ÿæ˜¯åƒåœ¾ä½¬é£æ ¼ ğŸ˜

ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦æ‹†åˆ† sfc å•æ–‡ä»¶ç»„ä»¶

è¯¥æ€ä¹ˆæ‹†åˆ†å‘¢ï¼Œä» load å¼€å§‹è¯»

<a href="https://github.com/vitejs/vite-plugin-vue/blob/main/packages/plugin-vue/src/index.ts">
  vue-plugin/index
</a>

```js
load(id, opt) {
//...
      if (query.vue) {
        if (query.src) {
          return fs.readFileSync(filename, 'utf-8')
        }
        const descriptor = getDescriptor(filename, options.value)!
        let block: SFCBlock | null | undefined
        if (query.type === 'script') {
          // handle <script> + <script setup> merge via compileScript()
          block = resolveScript(
            descriptor,
            options.value,
            ssr,
            customElementFilter.value(filename),
          )
        } else if (query.type === 'template') {
          block = descriptor.template!
        } else if (query.type === 'style') {
          block = descriptor.styles[query.index!]
        } else if (query.index != null) {
          block = descriptor.customBlocks[query.index]
        }
        if (block) {
          return {
            code: block.content,
            map: block.map as any,
          }
        }
      }
    },

```

ä»`getDescriptor`æˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹ä¸¤ä¸ªä½ç½®
ä»£ç ä½ç½®:`packages/plugin-vue/src/utils/descriptorCache.ts`

<img src="/vite/cyber/parse.png" />

æ³¨æ„è¿™ä¸ª`parse` ;ä¸ºäº†å¯»æ‰¾`complier`çš„ä½ç½®ï¼Œæˆ‘å¯»æ‰¾åˆ°äº†è¿™ä¸ªä½ç½®

ä»£ç ä½ç½®:`packages/plugin-vue/src/compiler.ts`

<img src="/vite/cyber/compiler.png" />

æˆ‘ä»¬æ‹¿åˆ°äº†ä¸¤ä¸ªä¿¡æ¯ ä¸€ä¸ªæ˜¯`vue/compiler-sfc` ä¸€ä¸ªæ˜¯ `parse`;
æ—¢ç„¶å¦‚æ­¤ æˆ‘ä»¬å°±`import {parse as vueParse,compileTemplate,compileScript} from "vue/compiler-sfc"`å¼•å…¥ parse å¯¹å…¶è¿›è¡Œè§£æ

```js
const vueAst = vueParse(code);
```

æˆ‘ä»¬å¾—åˆ°äº† vue çš„ ast è¯­æ³•æ ‘ï¼Œä»£ç æˆåŠŸçš„è¢«æˆ‘ä»¬æ‹†åˆ†äº†;ä»¥ä¸‹çš„ä»£ç å—éƒ½ç»è¿‡ç®€åŒ–

```js
{
  descriptor: {
    filename: 'anonymous.vue',
    source: `...`
    template: {
      type: 'template',
      content:  `...`,
      loc: [Object],
      attrs: {},
      ast: [Object],
      map: [Object]
    },
    script: {
      type: 'script',
      content:  `...`,
      loc: [Object],
      attrs: [Object],
      lang: 'ts',
      map: [Object]
    },
    scriptSetup: {
      type: 'script',
      content:  `...`,
      loc: [Object],
      attrs: [Object],
      setup: true,
      lang: 'ts'
    },
    styles: [],
    customBlocks: [],
    cssVars: [],
    slotted: false,
    shouldForceReload: [Function: shouldForceReload]
  },
  errors: []
}

```

æ¥ä¸‹æ¥å°±æ˜¯è½¬æ¢ä»£ç äº†ï¼›æˆ‘ä»¬æ¥ç€ load é’©å­å¼€å§‹è¯»

ä»`resolveScript`æˆ‘åˆæ‰¾åˆ°äº†ä»¥ä¸‹ä½ç½®

<img src="/vite/cyber/scriptSfc.png" />ï¼›

æˆ‘ä»¬å¼•å…¥`compileScript`å¯¹ script æ ‡ç­¾è¿›è¡Œå¤„ç†;

`let scriptRes = compileScript(vueAst.descriptor, { id: req.url });`
å¾—åˆ°ç»“æœ

```js
{
  type: 'script',
  content: ...,
  loc: {
  ....
  },
  attrs: { setup: true, lang: 'ts' },
  setup: true,
  lang: 'ts',
  bindings: {
    defineComponent: 'setup-const',
    ref: 'setup-const',
    count: 'setup-let',
    add: 'setup-const'
  },
  imports: [Object: null prototype] {
    defineComponent: {
      isType: false,
      imported: 'defineComponent',
      local: 'defineComponent',
      source: 'vue',
      isFromSetup: false,
      isUsedInTemplate: false
    },
    ref: {
      isType: false,
      imported: 'ref',
      local: 'ref',
      source: 'vue',
      isFromSetup: true,
      isUsedInTemplate: false
    }
  },
  map: []
    ,
    names: [],
    mappings: '...'
  },
  scriptAst: [
    Node {
      type: 'ImportDeclaration',
      start: 2,
      end: 40,
      loc: [SourceLocation],
      importKind: 'value',
      specifiers: [Array],
      source: [Node],
      attributes: []
    },
    Node {
      type: 'ExportDefaultDeclaration',
      start: 44,
      end: 222,
      loc: [SourceLocation],
      exportKind: 'value',
      declaration: [Node]
    }
  ],
  scriptSetupAst: [
    Node {
      type: 'ImportDeclaration',
      start: 2,
      end: 28,
      loc: [SourceLocation],
      importKind: 'value',
      specifiers: [Array],
      source: [Node],
      attributes: []
    },
    Node {
      type: 'VariableDeclaration',
      start: 30,
      end: 49,
      loc: [SourceLocation],
      declarations: [Array],
      kind: 'let'
    },
    Node {
      type: 'VariableDeclaration',
      start: 51,
      end: 92,
      loc: [SourceLocation],
      declarations: [Array],
      kind: 'const'
    }
  ],
  dep

```
å¦‚æ³•ç‚®åˆ¶ æ‰¾åˆ°`compileTemplate`å‡½æ•°ï¼Œå¯¹æ¨¡æ¿ä»£ç è¿›è¡Œå¤„ç†
```js
   let temp = compileTemplate({ source: vueAst.descriptor.template?.content as string, filename: realPath, id: req.url,  });
```

<img src="/vite/cyber/tempSfc.png" />
è¿™é‡Œæ˜¯template çš„ç¼–è¯‘ç»“æœ
```js
{
  code: 'import { toDisplayString as _toDisplayString, createElementVNode as _createElementVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "vue"\n' +
    '\n' +
    'export function render(_ctx, _cache) {\n' +
    '  return (_openBlock(), _createElementBlock("div", null, [\n' +
    '    _createElementVNode("div", null, "hello Vue " + _toDisplayString(_ctx.count), 1 /* TEXT */),\n' +
    '    _createElementVNode("button", {\n' +
    '      onClick: _cache[0] || (_cache[0] = (...args) => (_ctx.add && _ctx.add(...args)))\n' +
    '    }, "add")\n' +
    '  ]))\n' +
    '}',
  ast: {
    type: 0,
    source: '\r\n' +
      '  <div>\r\n' +
      '    <div>hello Vue {{ count }}</div>\r\n' +
      '    <button  @click="add">add</button>\r\n' +
      '  </div>\r\n',
    children: [ [Object] ],
    helpers: Set(4) {
      Symbol(toDisplayString),
      Symbol(createElementVNode),
      Symbol(openBlock),
      Symbol(createElementBlock)
    },
    components: [],
    directives: [],
    hoists: [],
    imports: [],
    cached: [ [Object] ],
    temps: 0,
    codegenNode: {
      type: 13,
      tag: '"div"',
      props: undefined,
      children: [Array],
      patchFlag: undefined,
      dynamicProps: undefined,
      directives: undefined,
      isBlock: true,
      disableTracking: false,
      isComponent: false,
      loc: [Object]
    },
    loc: {
      start: [Object],
      end: [Object],
      source: '\r\n' +
        '  <div>\r\n' +
        '    <div>hello Vue {{ count }}</div>\r\n' +
        '    <button  @click="add">add</button>\r\n' +
        '  </div>\r\n'
    },
    transformed: true,
    filters: []
  },
  preamble: '',
  source: '\r\n' +
    '  <div>\r\n' +
    '    <div>hello Vue {{ count }}</div>\r\n' +
    '    <button  @click="add">add</button>\r\n' +
    '  </div>\r\n',
  errors: [],
  tips: [],
  map: {
    version: 3,
    sources: [ 'D:\\code\\study\\vite\\minivite\\koaVite\\src\\cyber\\App.vue' ],
    names: [ 'count' ],
    mappings: ';;;wBACE,oBAGM;IAFJ,oBAAgC,aAA3B,YAAU,oBAAGA,UAAK;IACvB,oBAAkC;MAAxB,OAAK,0CAAE,6BAAG;OAAE,KAAG',
    sourcesContent: [
      '\r\n' +
        '  <div>\r\n' +
        '    <div>hello Vue {{ count }}</div>\r\n' +
        '    <button  @click="add">add</button>\r\n' +
        '  </div>\r\n'
    ]
  }
}

```
æˆ‘ä»¬åˆ†å‰²äº†å…¶sfcçš„ä»£ç åï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåšå‘¢ï¼›æˆ‘ä»¬æ¥çœ‹çœ‹ä¸€ä¸ªvue3çš„é¡¹ç›®,æœåŠ¡å™¨è¿”å›çš„vueæ–‡ä»¶æ˜¯ä»€ä¹ˆæ ·å­

```js
import { createHotContext as __vite__createHotContext } from "/@vite/client";import.meta.hot = __vite__createHotContext("/src/views/index.vue");import { defineComponent as _defineComponent } from "/node_modules/.vite/deps/vue.js?v=eaf793ab";
import { ElButton } from "/node_modules/.vite/deps/element-plus.js?v=eaf793ab";
import { testApi } from "/src/api/index.js";
import { defineComponent } from "/node_modules/.vite/deps/vue.js?v=eaf793ab";
const __default__ = defineComponent({
  name: ""
});
const _sfc_main = /* @__PURE__ */ _defineComponent({
  ...__default__,
  setup(__props, { expose: __expose }) {
    __expose();
    const sendTEst = async () => {
      let res = await testApi();
      console.log("ok", res);
    };
    const __returned__ = { sendTEst, get ElButton() {
      return ElButton;
    } };
    Object.defineProperty(__returned__, "__isScriptSetup", { enumerable: false, value: true });
    return __returned__;
  }
});
import { createTextVNode as _createTextVNode, withCtx as _withCtx, createVNode as _createVNode, openBlock as _openBlock, createElementBlock as _createElementBlock } from "/node_modules/.vite/deps/vue.js?v=eaf793ab";
function _sfc_render(_ctx, _cache, $props, $setup, $data, $options) {
  return _openBlock(), _createElementBlock("div", null, [
    _createVNode($setup["ElButton"], { onClick: $setup.sendTEst }, {
      default: _withCtx(() => _cache[0] || (_cache[0] = [
        _createTextVNode("hello world")
      ])),
      _: 1
      /* STABLE */
    }),
    _cache[1] || (_cache[1] = _createTextVNode(" 1111111 "))
  ]);
}
_sfc_main.__hmrId = "b301384e";
typeof __VUE_HMR_RUNTIME__ !== "undefined" && __VUE_HMR_RUNTIME__.createRecord(_sfc_main.__hmrId, _sfc_main);
import.meta.hot.on("file-changed", ({ file }) => {
  __VUE_HMR_RUNTIME__.CHANGED_FILE = file;
});
import.meta.hot.accept((mod) => {
  if (!mod) return;
  const { default: updated, _rerender_only } = mod;
  if (_rerender_only) {
    __VUE_HMR_RUNTIME__.rerender(updated.__hmrId, updated.render);
  } else {
    __VUE_HMR_RUNTIME__.reload(updated.__hmrId, updated);
  }
});
import _export_sfc from "/@id/__x00__plugin-vue:export-helper";
export default /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "D:/code/work/project/vite-project/src/views/index.vue"]]);

```
```js
export default (sfc, props) => {
    const target = sfc.__vccOpts || sfc;
    for (const [key,val] of props) {
        target[key] = val;
    }
    return target;
}
```
æˆ‘åœ¨é˜…è¯»æºç çš„æ—¶å€™ï¼Œå‘ç°vue3å®é™…ä¸Šæ˜¯é€šè¿‡é»˜è®¤æš´éœ²ä¸€ä¸ªvueå¯¹è±¡ï¼Œè¿™ä¸ªvueå¯¹è±¡å°±æ˜¯å…¶ç»„ä»¶ï¼›æˆ‘ä»ä¸Šé¢æºç è·å–åˆ°çš„ä¿¡æ¯å°±æ˜¯vueæ–‡ä»¶æ—¶æš´éœ²ä¸€ä¸ª`default`,è¿™ä¸ªdefaultä¼šæ ¹æ®æ”¹å†™å…¶renderå’Œ__fileå±æ€§ï¼›å°†å…¶è§†ä¸ºvueç»„ä»¶ï¼Œæˆ‘ä»¬åšçš„ç¬¬ä¸€æ­¥å°±æ˜¯å°†`_sfc_main`çš„`render`æ›¿æ¢ä¸º`compileTemplate`å¤„ç†è¿‡åçš„`render`æ–¹æ³•ï¼›è¦æƒ³å°†å…¶åˆå¹¶ï¼Œæˆ‘ä»¬å…ˆå°†å…¶æ‹¼æ¥
```js
     let arr = [scriptRes.content, temp.code]
        code = arr.join("\n");

```
æœ€ç»ˆæˆ‘ä»¬å¾—åˆ°æ··åˆçš„ä»£ç å—ï¼›æˆ‘ä»¬çš„vue-loaderç®—æ˜¯åˆæ­¥å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å»å¤„ç†ä»–çš„code

#### vue-plugin transform
å› ä¸ºæˆ‘ä»¬ä¸»è¦å¤„ç†çš„æ˜¯å¯¼å‡ºæ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡` const [imports, exports] = parse(transformedCode);`å¯¹ä»–çš„exportè¿›è¡Œæ”¹å†™
```js

 if (req.url?.endsWith(".vue")) {
        for (const exportInfo of exports) {
          const { n: exportId, s: start, e: end } = exportInfo;
          if (!exportInfo) continue;

          if (exportId === "default") ms.overwrite(start, end, "other");
          // console.log(realPath)
          code = ms.toString() + `let sfc_main =stdin_default.__vccOpts || stdin_default;sfc_main.render =render};\n sfc_main.__file = "${realPath}";\nexport default /* @__PURE__ */sfc_main`
        }
      }
```
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘å°†`default`è¿›è¡Œäº†å¤„ç†;è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼›å› ä¸ºä»–è§£æå‡ºæ¥çš„ä»£ç é»˜è®¤å°±æ˜¯ä¸€ä¸ª`default`å¯¼å‡ºï¼›æˆ‘å°†å…¶æ”¹å†™ä¸ºé`default`å¯¼å‡ºï¼Œè¿™ä¸ªä½ç½®éœ€è¦ç•™ç»™vueå®ä¾‹;ç„¶åæˆ‘ä»¬å¯¹å…¶è¿›è¡Œæ”¹å†™ï¼Œå°†`stdin_default`ï¼ˆè¿™ä¸ªæ˜¯scriptè§£æçš„ç»“æœï¼‰çš„å±æ€§æ”¹å†™ï¼Œå¹¶æä¾›æ–°çš„åå­—`sfc_main`;`sfc_main.render =render`å°†åŸºæœ¬ä¿¡æ¯æ”¹å†™å®Œæˆ‘ä»¬å°†å…¶å¯¼å‡º `export default /* @__PURE__ */sfc_main`;
è¿™æ˜¯App.vueçš„ä»£ç 
```vue
<template>
  <div>
    <div>hello Vue {{ count }}</div>
    <button  @click="add">add</button>
  </div>
</template>
<script lang="ts">
import { defineComponent } from "vue";

export default defineComponent({
  name: "App",
});
</script>
<script setup lang="ts">
import { ref } from "vue";
let count = ref(0);
const add = () => {
  count.value++;
};
</script>

```
æˆ‘ä»¬æ¥çœ‹çœ‹é¡µé¢
<img src="/vite/cyber/noref.png" />

ğŸ¥œï¼Œä½ åˆå‘ç°äº†å¿™ç‚¹ï¼Œæ€ä¹ˆå“åº”å¼æ•°æ®æ²¡æœ‰

æˆ‘å¯¹å…¶`sfc_main`çš„renderå‚æ•°è¿›è¡Œæ‰“å°

<img src="/vite/cyber/render_arg.png" />

æˆ‘å‘ç°å…¶æ˜¯æœ‰å€¼çš„ï¼Œæ’é™¤æ³•å¾—åˆ°åº”è¯¥æ˜¯æˆ‘çš„renderæœ‰é—®é¢˜ï¼›æˆ‘åœ¨é‡æ–°å»æ£€æŸ¥`compileTemplate`çš„å‚æ•°ï¼Œå¹¶å»æŸ¥è¯¢å…¶æºç 
<a href="https://github.com/vitejs/vite-plugin-vue/blob/main/packages/plugin-vue/src/template.ts">vite-plugin-vue/packages/plugin-vue/src
/template.ts</a>

<img src="/vite/cyber/tempOptions.png" />

æˆ‘å‘ç°å…¶`bindingMetadata`ï¼›åœ¨vue3çš„æºç çš„é˜…è¯»ä¸­ï¼Œ`bind`æˆ‘ä»¬ä¸€èˆ¬çŸ¥é“å«æœ‰è¿™ä¸ªè¯çš„ä¸€èˆ¬ä¸ºä¼ é€’å‚æ•°ï¼›æˆ‘åˆšå¥½å‘ç°åœ¨scriptè¿”å›å€¼çš„tsç±»å‹ä¸­åˆšå¥½æœ‰è¿™ä¸ªå€¼
```ts
export interface SFCScriptBlock extends SFCBlock {
    type: 'script';
    setup?: string | boolean;
    bindings?: BindingMetadata$1;
    imports?: Record<string, ImportBinding>;
    scriptAst?: _babel_types.Statement[];
    scriptSetupAst?: _babel_types.Statement[];
    warnings?: string[];
    /**
     * Fully resolved dependency file paths (unix slashes) with imported types
     * used in macros, used for HMR cache busting in @vitejs/plugin-vue and
     * vue-loader.
     */
    deps?: string[];
}
```
é‚£æˆ‘ä»¬æŠŠä»–åŠ è¿›å»
```ts
       let temp = compileTemplate({ source: vueAst.descriptor.template?.content as string, filename: realPath, id: req.url, slotted: vueAst.descriptor.slotted, compilerOptions: { bindingMetadata: scriptRes.bindings } });
    

```

æˆ‘ä»¬çš„ä»£ç å°±èƒ½æ­£å¸¸å·¥ä½œäº†ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨vueçš„å¼€å‘è€…å·¥å…·;
<img src="/vite/cyber/res.gif" />

è¿™é‡Œæ˜¯å®Œæ•´çš„ä»£ç 
```ts
import Koa from "koa";
import { optimize } from "./node/optimizer";
import { init, parse } from "es-module-lexer";
import MagicString from "magic-string";
import fs from "fs-extra";
import esbuild from "esbuild"
import path from "path";
import {
  parse as vueParse,
  compileTemplate,
  compileScript,
} from "vue/compiler-sfc"
const root = process.cwd();


const app = new Koa();

app.use(async (ctx, next) => {
  const { req, res } = ctx;
  if (req.url === "/") {
    const realPath = path.join(process.cwd(), "/cyber.html");
    //transformHtml
    if (await fs.pathExists(realPath)) {
      let code = await fs.readFile(realPath, "utf-8");
      res.setHeader("Content-Type", "text/html");
      res.end(code)
    }
  } else if ((req.method === "GET" || /\.(?:j|t)sx?$|\.mjs$|\.vue$/.test(req.url as string))) {
    //resolve
    const realPath = path.join(process.cwd(), req.url + "");
    //loader
    if (await fs.pathExists(realPath)) {

      let code = await fs.readFile(realPath, "utf-8");
      //vue-plugin loader
      if (req.url?.endsWith(".vue")) {
        const vueAst = vueParse(code);
        let scriptRes = compileScript(vueAst.descriptor, { id: req.url });
        let temp = compileTemplate({ source: vueAst.descriptor.template?.content as string, filename: realPath, id: req.url, slotted: vueAst.descriptor.slotted, compilerOptions: { bindingMetadata: scriptRes.bindings } });
    
 
        let arr = [scriptRes.content, temp.code]
        code = arr.join("\n");

      }
      let exname = path.extname(req.url as string).slice(1) === "vue" ? "js" :path.extname(req.url as string).slice(1)
      let { code: transformedCode, map } = await esbuild.transform(code, {
        target: "esnext",
        format: "esm",
        sourcemap: true,
        loader: exname as "js" | "ts" | "jsx" | "tsx",
      });
  
      //  transform
      const ms = new MagicString(transformedCode);
      await init;
      const [imports, exports] = parse(transformedCode);

      for (const importInfo of imports) {
        const { n: importedId, s: start, e: end } = importInfo;

        if (!importedId) continue;
        if (/^[\w@][^:]/.test(importedId)) {

          let realPath = path.join('/', "node_modules", ".m-vite", `${importedId}.js`);
          realPath = realPath.replace(/\\/g, "/");
         
          ms.overwrite(start, end, realPath);
          code = ms.toString();
        }

      }
      // vue-plugin transform
      if (req.url?.endsWith(".vue")) {
        for (const exportInfo of exports) {
          const { n: exportId, s: start, e: end } = exportInfo;
          if (!exportInfo) continue;

          if (exportId === "default") ms.overwrite(start, end, "other");
          // console.log(realPath)
          code = ms.toString() + `let sfc_main =stdin_default.__vccOpts || stdin_default;sfc_main.render = function(...arg){console.log(arg);return render(...arg)};\n sfc_main.__file = "${realPath}";\nexport default /* @__PURE__ */sfc_main`
        }
      }
      res.setHeader("Content-Type", "application/javascript");


      res.statusCode = 200;
      res.end(code)
    }
  }
  return next()
})


app.listen(8954, async () => {
  await optimize(root, "src/cyber/react.tsx")
  await optimize(root, "src/cyber/vue.ts")
  console.log("http://localhost:8954 ")
})

```

ä»€ä¹ˆå«åšèµ›åšæœ‹å…‹ï¼Ÿè¿™å°±å«èµ›åšæœ‹å…‹ï¼›åƒåœ¾ä½¬çš„å“²å­¦è§‚ï¼Œåˆä¸æ˜¯ä¸èƒ½è·‘ğŸ˜ï¼›

é“ä»”ï¼›éƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œç‚¹ä¸ªèµå†èµ°å‘—
